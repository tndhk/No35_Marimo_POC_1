# お弁当販売数予測 分析計画書

## 1. プロジェクト概要

### 1.1 課題
会社のカフェフロアで販売されるお弁当の販売数を予測するモデルを構築する。

### 1.2 データ
| 項目 | 訓練データ | テストデータ |
|------|-----------|-------------|
| ファイル | bento_train.csv | bento_test.csv |
| 行数 | 207行 | 40行 |
| 期間 | 2013-11-18〜2014-09-30 | 2014-10-01〜2014-11-28 |

### 1.3 カラム構成
| カラム | 説明 | 欠損 |
|--------|------|------|
| datetime | 日付（yyyy-m-d） | なし |
| y | 販売数（目的変数） | テストになし |
| week | 曜日（月〜金） | なし |
| soldout | 売り切れフラグ | あり |
| name | お弁当名 | なし |
| kcal | カロリー | 多い |
| remarks | 備考 | 多い |
| event | イベント情報 | 多い |
| payday | 給料日フラグ | 多い |
| weather | 天気 | なし |
| precipitation | 降水量 | "--"あり |
| temperature | 気温 | わずか |

### 1.4 評価指標
RMSE（Root Mean Squared Error）- 小さいほど良い

### 1.5 出力形式
- CSVファイル（ヘッダーなし）
- 1列目: 日付（ゼロ埋めなし: `2014-10-1`）
- 2列目: 予測値

---

## 2. 分析フェーズ

### Phase 1: データ理解とEDA（まず実装）

目的: データの特性を深く理解し、モデリング戦略を決定する

#### 実装内容

| セル | 内容 | 目的 |
|------|------|------|
| 1-1 | ライブラリインポート | 環境準備 |
| 1-2 | 訓練データロード | データ読み込み |
| 1-3 | テストデータロード | データ読み込み |
| 1-4 | タイトル・概要表示 | プロジェクト説明 |
| 1-5 | 基本統計量 | describe()確認 |
| 1-6 | 欠損値確認 | 各カラムの欠損状況 |
| 1-7 | 目的変数分析 | y（販売数）の分布 |
| 1-8 | カテゴリ変数集計 | 曜日/天気/売切別 |

#### 確認ポイント
- [ ] 販売数（y）の分布は正規分布に近いか？
- [ ] 外れ値はあるか？
- [ ] 欠損パターンは？

---

#### 可視化セル

| セル | 可視化 | 確認内容 |
|------|--------|----------|
| 1-9 | Pandas変換 | 可視化用に1回のみ変換 |
| 1-10 | 販売数ヒストグラム | 分布形状 |
| 1-11 | 時系列トレンド | 季節性・トレンド |
| 1-12 | 曜日別ボックスプロット | 曜日効果 |
| 1-13 | 天気別ボックスプロット | 天気の影響 |
| 1-14 | 気温散布図 | 気温との相関 |
| 1-15 | 相関行列ヒートマップ | 変数間の関係 |
| 1-16 | 月×曜日ヒートマップ | 組み合わせ効果 |

#### 確認ポイント
- [ ] 曜日ごとの販売数差はどの程度？
- [ ] 天気による変動は？
- [ ] 気温と販売数に相関はあるか？
- [ ] 月ごとのトレンドは？

---

### Phase 2: 特徴量エンジニアリング

目的: EDAの知見を基に予測に有効な特徴量を設計

#### 基本特徴量
| 特徴量 | 説明 | 推奨度 |
|--------|------|--------|
| year | 年 | ☆☆☆ |
| month | 月 | ☆☆☆☆☆ |
| day | 日 | ☆☆☆ |
| dayofweek | 曜日（数値） | ☆☆☆☆☆ |
| weekofyear | 週番号 | ☆☆☆ |

#### 曜日ワンホット
| 特徴量 | 推奨度 |
|--------|--------|
| week_月〜week_金 | ☆☆☆☆☆ |

#### 天気関連
| 特徴量 | 説明 | 推奨度 |
|--------|------|--------|
| weather_快晴〜weather_雷電 | ワンホット | ☆☆☆☆ |
| is_bad_weather | 悪天候フラグ | ☆☆☆☆ |
| temperature | 気温（欠損補完） | ☆☆☆☆ |
| precipitation | 降水量 | ☆☆☆ |

#### メニュー関連
| 特徴量 | パターン | 推奨度 |
|--------|----------|--------|
| menu_curry | カレー | ☆☆☆ |
| menu_fry | フライ/カツ/唐揚げ | ☆☆☆ |
| menu_hamburg | ハンバーグ | ☆☆ |
| menu_fish | 魚/サバ/鮭 | ☆☆ |
| menu_meat | 肉/牛/豚/鶏 | ☆☆ |

#### 時期・イベント関連
| 特徴量 | 説明 | 推奨度 |
|--------|------|--------|
| is_beginning_of_month | 月初（1-10日） | ☆☆☆ |
| is_end_of_month | 月末（21日以降） | ☆☆☆ |
| payday | 給料日フラグ | ☆☆☆ |
| event_flag | イベント有無 | ☆☆ |

#### 交互作用
| 特徴量 | 説明 | 推奨度 |
|--------|------|--------|
| week_month | 曜日×月 | ☆☆☆ |
| temp_month | 気温×月 | ☆☆☆ |

---

### Phase 3: ベースラインモデル

目的: シンプルなモデルで基準スコアを取得

#### 実装内容
- 線形回帰（LinearRegression）
- 基本特徴量のみ使用（4〜5個）
- TimeSeriesSplit交差検証

#### 期待結果
- RMSE: 15〜20程度（ベースライン）

---

### Phase 4: 高度なモデリング（EDA結果を見てから判断）

目的: LightGBMによる精度向上

#### 検討内容
- 時系列ラグ特徴量（lag_1, lag_5, rolling_mean）
- Optuna によるハイパーパラメータ最適化
- 再帰的予測（テストデータ用）

#### 目標
- RMSE: 10以下

---

## 3. 技術スタック

### requirements.txt
```
marimo>=0.19.0
polars-lts-cpu>=0.20.0
altair>=5.2.0
pyarrow>=12.0.0
pandas>=1.5.0
scikit-learn>=1.3.0
lightgbm>=4.0.0
optuna>=3.0.0
```

---

## 4. 実装ルール

### 4.1 データリーク防止（最重要）

```python
# 正しい: 訓練データの統計量を使用
train_kcal_median = df_train['kcal'].median()
df_test_fe = df_test.with_columns(
    pl.col('kcal').fill_null(train_kcal_median)
)

# 間違い: テストデータ自身の統計量を使用
# df_test_fe = df_test.with_columns(
#     pl.col('kcal').fill_null(pl.col('kcal').median())
# )
```

### 4.2 marimoセル設計

1. 変数再定義禁止
   - 各変数は1つのセルでのみ定義

2. 依存関係の明示
```python
@app.cell
def _(df_train, pl):  # 引数で依存を明示
    stats = df_train.describe()
    return stats,
```

3. Pandas変換は1回のみ
   - 可視化用に専用セルで変換

### 4.3 日付フォーマット

```python
# ゼロ埋めなし形式
# OK: 2014-10-1
# NG: 2014-10-01

def format_date(dt):
    return f"{dt.year}-{dt.month}-{dt.day}"
```

---

## 5. 進め方

### Step 1: Phase 1を実装
- EDAノートブックを作成
- データの特性を把握

### Step 2: 分析結果を確認
- 可視化を見ながら議論
- 特徴量の有効性を検討

### Step 3: Phase 2-3を実装
- 特徴量エンジニアリング
- ベースラインモデル

### Step 4: Phase 4を検討
- EDA結果を踏まえて高度なモデリングを判断

---

## 6. 次のアクション

1. [ ] requirements.txt 作成
2. [ ] Phase 1: EDAノートブック作成
3. [ ] EDA結果の確認・議論
4. [ ] Phase 2-3 の実装判断
